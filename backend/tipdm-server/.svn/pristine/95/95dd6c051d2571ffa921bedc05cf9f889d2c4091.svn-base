package com.tipdm.framework.dmserver.core.task.handler;

import org.quartz.*;
import org.quartz.impl.matchers.GroupMatcher;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Set;

/**
 * Created by TipDM on 2018/6/30.
 */
public class FailedJobHandler implements Runnable {

    private final static Logger LOGGER = LoggerFactory.getLogger(FailedJobHandler.class);
    private final static Long QUARTER_HOUR = 1000 * 60 * 15L;

    private Scheduler scheduler;

    public FailedJobHandler(Scheduler scheduler) {
        this.scheduler = scheduler;
        LOGGER.debug("Init FailedJobHandler");
    }

    @Override
    public void run() {

        while (true) {
            GroupMatcher<TriggerKey> matcher = GroupMatcher.anyTriggerGroup();
            try {
                Set<TriggerKey> triggers = scheduler.getTriggerKeys(matcher);
                triggers.forEach(x -> {
                    try {
                        Trigger trigger = scheduler.getTrigger(x);
                        if (trigger instanceof SimpleTrigger) {
                            Trigger.TriggerState state = scheduler.getTriggerState(x);
                            if(Trigger.TriggerState.ERROR.compareTo(state) == 0){
//                                scheduler.unscheduleJob(x);
//                                LOGGER.debug("unScheduleJob with triggerKey: {}", x.toString());
                            }
                        }
                    } catch (SchedulerException e) {

                    }
                });
            } catch (SchedulerException e) {
                LOGGER.error("remove trigger failed, because: {}", e.getMessage());
            }
            try {
                Thread.sleep(QUARTER_HOUR);
            } catch (InterruptedException e) {

            }
        }

    }
}
