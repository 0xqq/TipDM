package com.tipdm.framework.dmserver.task.job;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.tipdm.framework.common.utils.PropertiesUtil;
import com.tipdm.framework.dmserver.core.algo.IAlgorithm;
import com.tipdm.framework.dmserver.core.task.model.Job;
import com.tipdm.framework.dmserver.core.task.schedule.State;
import com.tipdm.framework.dmserver.rpc.MessageManager;
import com.tipdm.framework.dmserver.utils.Constants;
import com.tipdm.framework.dmserver.utils.RedissonUtils;
import com.tipdm.framework.dmserver.websocket.dto.WorkFlowMessage;
import com.tipdm.framework.model.dmserver.Component;
import com.tipdm.framework.service.dmserver.MessageService;
import org.quartz.JobDataMap;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.redisson.api.RMapCache;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;
import org.springframework.scheduling.quartz.QuartzJobBean;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.PrintWriter;
import java.util.Map;

/**
 * @author zhoulong E-mail:devp@tipdm.com
 * @version 创建时间：2016年11月7日 下午2:25:17 类说明
 */
//@PersistJobDataAfterExecution
//@DisallowConcurrentExecution
public class WorkFlowJobBean extends QuartzJobBean {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());


    public void executeInternal(JobExecutionContext context) throws JobExecutionException {

        try {
            JobDataMap jobDataMap = context.getJobDetail().getJobDataMap();
            Job job = null;
            try {
                job = (Job) jobDataMap.get("job");
            }catch (ClassCastException ex) {
                job = JSON.parseObject(jobDataMap.getString("job"), Job.class);
            }
            Component component;
            Object attachment = job.getAttachment().get("component");
            if(attachment instanceof JSONObject){
                component = JSON.parseObject(attachment.toString(), Component.class);
            } else {
                component = (Component) attachment;
            }

            truncateLog(component);
            Class clazz;
            try {
                clazz = Class.forName(job.getTargetClazz());
            }catch (ClassNotFoundException ex){
                clazz = Class.forName("com.tipdm.framework.dmserver.core.algo.unparallel.CommonAlgorithm");
            }
            IAlgorithm algorithm = (IAlgorithm) clazz.newInstance();
            if (!component.getEnabled()) {
                throw new IllegalAccessException("组件初始化失败，错误信息：当前组件已被管理员禁用");
            }

            String accessToken = jobDataMap.getString("accessToken");
            RMapCache<String, Map<String, String>> mapCache = RedissonUtils.getRMapCache(Constants.WS_CLIENTS);
            Map<String, String> mapping = mapCache.get(accessToken);
            String sessionId = mapping.get("sessionId");
            String rpcAddress = mapping.get("rpcAddress");
            MessageService messageService = MessageManager.getService(rpcAddress);
            //更新状态并推送到前端
            WorkFlowMessage message = new WorkFlowMessage();
            message.setNodeId(job.getJobId());
            message.setState(State.RUNNING);
            messageService.notifyWorkFlowExecStatus(job.getJobGroup(), sessionId, message);
            logger.info("job '" +context.getJobDetail().getKey().getName()+ "' will be execute");
            algorithm.run(component);
        } catch (Exception e) {
            throw new JobExecutionException(e);
        }
    }

    @SuppressWarnings("all")
    private void truncateLog(Component component) {
        String id = component.getClientId().toString();
        String log_home = PropertiesUtil.getValue("sysconfig/system.properties", "LOG_HOME");
        try {
            PrintWriter writer = new PrintWriter(new File(log_home + "/" + id + ".log"));
            writer.print("");
            writer.flush();
            writer.close();
        } catch (FileNotFoundException e) {
            logger.error("FileNotFoundException: {}", e);
        }
        MDC.put("component", id);
    }
}
